# LUMI Exhaust Sweep Schedule

## CMF Inventory

| Type | Rank | Matrix | Dim | Axes | Count |
|------|------|--------|-----|------|-------|
| 2F2 | 3 | 3×3 | 4 | x0, x1, y0, y1 | 1,000 |
| 3F3 | 4 | 4×4 | 6 | x0, x1, x2, y0, y1, y2 | 1,000 |
| **Total** | | | | | **2,000** |

CMF specs generated by `dreams_rocm/cmf_generator.py` using Pochhammer
parameter pool: integers ±5, halves ±9/2, thirds ±2, quarters ±2.
Deduplicated by canonical parameter ordering + SHA-256 hash.

---

## Trajectory Coverage

Primitive integer vectors in Z^d with L∞ ≤ k_max, canonical normalization
(gcd-reduced, first nonzero positive).

| Dimension | k_max | Unique trajectories |
|-----------|-------|---------------------|
| dim=4 (2F2) | 3 | **1,120** |
| dim=6 (3F3) | 2 | **7,448** |

---

## Shift Coverage

Sobol low-discrepancy sequence quantized to rationals with denominators
∈ {2, 3, 4, 6, 8}, centered in [-1/2, 1/2)^d, deduplicated.

| Dimension | Stage 1 | Stage 2 | Stage 3 (full) |
|-----------|---------|---------|----------------|
| dim=4 | 64 | 256 | 512 |
| dim=6 | 64 | 256 | 1,024 |

---

## Staged Exhaust Policy

### Stage 1 — Triage (all 2,000 CMFs)

Run every CMF with 64 shifts × full trajectories. Identify CMFs that
produce any delta > −2.0 ("signal").

| Metric | dim=4 | dim=6 | Total |
|--------|-------|-------|-------|
| CMFs | 1,000 | 1,000 | 2,000 |
| Runs/CMF | 71,680 | 476,672 | — |
| Total runs | 71.7M | 476.7M | **548.4M** |
| Est. GPU-hours (8 GPUs) | ~1.2h | ~8.3h | **~9.5h** |
| LUMI billing (small-g) | | | ~76 GPU-h |

**Wallclock: ~10 hours on 1 node (8× MI250X)**

Submit:
```bash
python scripts/generate_exhaust_tasks.py \
    --cmfs cmfs_exhaust.jsonl --stage 1 --n-gpus 8 \
    --output-dir tasks/stage1/
sbatch scripts/sbatch_exhaust.sh --stage 1
```

Output: `stage1_results/` with per-GPU JSONL + `stage1_hits.txt` (hashes
of CMFs with signal).

### Stage 2 — Confirm (top ~200 CMFs)

Run CMFs that showed signal in Stage 1 with 256 shifts × full trajectories.
Expected ~10% of CMFs pass triage → ~200 CMFs.

| Metric | dim=4 (~100) | dim=6 (~100) | Total |
|--------|--------------|--------------|-------|
| Runs/CMF | 286,720 | 1,906,688 | — |
| Total runs | 28.7M | 190.7M | **~219M** |
| Est. GPU-hours | ~0.5h | ~3.3h | **~3.8h** |

**Wallclock: ~4 hours**

Submit:
```bash
python scripts/generate_exhaust_tasks.py \
    --cmfs cmfs_exhaust.jsonl --stage 2 \
    --include-list stage1_hits.txt --n-gpus 8 \
    --output-dir tasks/stage2/
sbatch scripts/sbatch_exhaust.sh --stage 2
```

### Stage 3 — Full Exhaust (top ~20 CMFs)

Run top candidates with full shift coverage.
Expected ~10% of Stage 2 pass → ~20 CMFs.

| Metric | dim=4 (~10) | dim=6 (~10) | Total |
|--------|-------------|-------------|-------|
| Runs/CMF | 573,440 | 7,626,752 | — |
| Total runs | 5.7M | 76.3M | **~82M** |
| Est. GPU-hours | ~0.1h | ~1.3h | **~1.4h** |

**Wallclock: ~2 hours**

---

## Total Compute Budget

| Stage | CMFs | Total runs | Wall hours | GPU-hours |
|-------|------|------------|------------|-----------|
| 1 (triage) | 2,000 | 548M | ~10h | 76 |
| 2 (confirm) | ~200 | ~219M | ~4h | 30 |
| 3 (exhaust) | ~20 | ~82M | ~2h | 11 |
| **Total** | | **~849M** | **~16h** | **~117** |

**Conservative estimate: 120 GPU-hours on LUMI small-g partition.**

Assuming 0.5 ms/run at depth=2000, K=32 on MI250X. Actual throughput
depends on matrix rank (3×3 vs 4×4) and polynomial degree.

---

## LUMI Job Configuration

```
Partition:    small-g
Nodes:        1
GPUs/node:    8 (MI250X)
CPUs/GPU:     7
Memory:       480 GB
Container:    dreams_rocm.sif (Singularity)
Billing:      per-GPU (small-g)
```

### Recommended time limits

| Stage | `--time` |
|-------|----------|
| 1 | `12:00:00` |
| 2 | `06:00:00` |
| 3 | `04:00:00` |

---

## RNS Parameters

| Parameter | Value | Notes |
|-----------|-------|-------|
| K | 32 | 31-bit primes → 992-bit capacity |
| depth | 2000 | Walk steps |
| K_small | 6 | Primes for partial CRT triage |
| delta_threshold | −2.0 | Stage 1 triage cutoff |
| escalate_threshold | 0.0 | Full CRT verification |

---

## File Layout

```
DreamsRNS-ROCm-LUMI/
├── cmfs_exhaust.jsonl              # 2000 CMF specs (generated)
├── tasks/
│   ├── stage1/
│   │   ├── manifest.json           # Stage config + run counts
│   │   └── tasks_gpu{0-7}.jsonl    # Per-GPU task lists
│   ├── stage2/
│   │   ├── manifest.json
│   │   └── tasks_gpu{0-7}.jsonl
│   └── stage3/
│       ├── manifest.json
│       └── tasks_gpu{0-7}.jsonl
├── results/
│   ├── stage1/
│   │   ├── results_gpu{0-7}.jsonl
│   │   └── stage1_hits.txt         # CMF hashes with signal
│   ├── stage2/
│   │   └── ...
│   └── stage3/
│       └── ...
```

---

## Workflow

```bash
# 1. Generate CMFs (one-time, on login node)
python -m dreams_rocm.cmf_generator \
    --n2f2 1000 --n3f3 1000 -o cmfs_exhaust.jsonl

# 2. Generate Stage 1 tasks
python scripts/generate_exhaust_tasks.py \
    --cmfs cmfs_exhaust.jsonl --stage 1 --n-gpus 8

# 3. Submit Stage 1
sbatch scripts/sbatch_1node_8gpu.sh   # or sbatch_exhaust.sh

# 4. After Stage 1 completes: extract hits
python scripts/extract_hits.py results/stage1/ > stage1_hits.txt

# 5. Generate + submit Stage 2
python scripts/generate_exhaust_tasks.py \
    --cmfs cmfs_exhaust.jsonl --stage 2 \
    --include-list stage1_hits.txt
sbatch scripts/sbatch_1node_8gpu.sh

# 6. Repeat for Stage 3
python scripts/generate_exhaust_tasks.py \
    --cmfs cmfs_exhaust.jsonl --stage 3 \
    --include-list stage2_hits.txt
sbatch scripts/sbatch_1node_8gpu.sh
```

---

## Compute Scaling Notes

- **dim=6 dominates**: 87% of Stage 1 compute is 3F3 (dim=6) due to 7,448 trajectories
- **Staged approach saves ~85%**: Full exhaust of all 2,000 CMFs would be ~8.2B runs; staging reduces to ~849M
- **If budget allows**: increase k_max for dim=4 to 4 (→ ~3,360 trajectories) or dim=6 to 3 (→ ~86,000 trajectories — probably too many)
- **Parallelism**: Each CMF×trajectory×shift is independent → trivially distributable across nodes. For multi-node, just split task files across nodes
